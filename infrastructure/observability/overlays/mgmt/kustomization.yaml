# ClusterSecretStore is intentionally NOT referenced here.
# It lives in external-secrets/overlays/mgmt/ and is guaranteed to exist
# by the time this app syncs (wave 3 in infra-appset.yaml).
#
# Within this app, sync waves ensure:
#   Wave 0 (default) — kube-prometheus-stack Helm chart (creates ServiceAccount
#                       prometheus-grafana that ClusterSecretStore auth uses)
#   Wave 2           — grafana-external-secret (fires after chart is deployed)
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

labels:
  - pairs:
      env: mgmt
      tier: infra

helmGlobals:
  chartHome: /tmp

helmCharts:
  - name: kube-prometheus-stack
    repo: https://prometheus-community.github.io/helm-charts
    version: 69.6.0
    releaseName: prometheus
    namespace: observability
    valuesFile: values.yaml
    includeCRDs: true        # explicitly render CRDs as part of the manifest

resources:
  - grafana-external-secret.yaml
  - grafana-httproute.yaml